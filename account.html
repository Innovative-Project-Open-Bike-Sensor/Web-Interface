<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Account</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="iframe-page">
  <div id="login-form">
    <h2>Login</h2>
    <form id="login">
      <label for="username">Username:</label>
      <input type="text" id="username" required>
      <label for="password">Password:</label>
      <input type="password" id="password" required>
      <button type="submit">Login</button>
    </form>
    <p id="login-error" style="color: red; display: none;"></p>
  </div>

  <div id="user-panel" style="display: none;">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <h3>Your Imports</h3>
    <ul id="imports-list"></ul>
    <button id="change-password-btn">Change Password</button>
    <button id="logout-btn">Logout</button>
  </div>

  <div id="change-password-form" style="display: none;">
    <h2>Change Password</h2>
    <form id="change-password">
      <label for="new-password">New Password:</label>
      <input type="password" id="new-password" required>
      <button type="submit">Update</button>
      <button type="button" id="cancel-change">Cancel</button>
    </form>
    <p id="change-password-error" style="color: red; display: none;"></p>
  </div>

  <script>
    const loginForm = document.getElementById('login-form');
    const userPanel = document.getElementById('user-panel');
    const changePasswordForm = document.getElementById('change-password-form');
    const userNameSpan = document.getElementById('user-name');
    const importsList = document.getElementById('imports-list');
    const loginError = document.getElementById('login-error');
    const changePasswordError = document.getElementById('change-password-error');

    // Vérifie si l'utilisateur est connecté
    if (localStorage.getItem('loggedIn') === 'true') {
      checkLoginStatus();
    }

    // Soumission du formulaire de login
    document.getElementById('login').addEventListener('submit', async function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch('https://lilied-subprofessionally-mafalda.ngrok-free.dev/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: username, password: password })
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('loggedIn', 'true');
          localStorage.setItem('user', username);
          showUserPanel(username);
          window.parent.postMessage({ action: 'loginSuccess' }, '*');
        } else {
          loginError.textContent = data.error || 'Login failed.';
          loginError.style.display = 'block';
        }
      } catch (error) {
        loginError.textContent = 'Network error. Please try again.';
        loginError.style.display = 'block';
      }
    });

    // Vérifie le statut de connexion
    function checkLoginStatus() {
      const username = localStorage.getItem('user');
      if (!username) return;

      showUserPanel(username);
    }

    // Affiche le panneau utilisateur
    function showUserPanel(username) {
      userNameSpan.textContent = username;
      loginForm.style.display = 'none';
      userPanel.style.display = 'block';
      loadImports();
    }

    // Charge la liste des imports depuis le serveur
    async function loadImports() {
      try {
        const response = await fetch('https://lilied-subprofessionally-mafalda.ngrok-free.dev/api/measurements?limit=100', {
          headers: {
            'X-API-KEY': 'openbikecle',
            'ngrok-skip-browser-warning': 'true'
          }
        });

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        const contentType = response.headers.get('Content-Type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Réponse non-JSON reçue');
        }

        const imports = await response.json();
        importsList.innerHTML = '';

        if (imports.length === 0) {
          importsList.innerHTML = '<li>Aucune donnée importée.</li>';
          return;
        }

        imports.forEach(imp => {
          const li = document.createElement('li');
          li.textContent = `Track at (${imp.lat}, ${imp.lng}) on ${imp.day}/${imp.month}/${imp.year}`;
          importsList.appendChild(li);
        });
      } catch (error) {
        console.error('Erreur chargement imports:', error);
        importsList.innerHTML = '<li>Erreur de chargement des données.</li>';
      }
    }

    // Bouton pour changer le mot de passe
    document.getElementById('change-password-btn').addEventListener('click', function() {
      userPanel.style.display = 'none';
      changePasswordForm.style.display = 'block';
    });

    // Annuler le changement de mot de passe
    document.getElementById('cancel-change').addEventListener('click', function() {
      changePasswordForm.style.display = 'none';
      userPanel.style.display = 'block';
    });

    // Soumission du formulaire de changement de mot de passe
    document.getElementById('change-password').addEventListener('submit', async function(e) {
      e.preventDefault();
      const newPassword = document.getElementById('new-password').value;
      const username = localStorage.getItem('user');

      try {
        const response = await fetch('https://lilied-subprofessionally-mafalda.ngrok-free.dev/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify({ id: username, password: newPassword })
        });

        const data = await response.json();

        if (response.ok) {
          alert('Mot de passe changé avec succès !');
          changePasswordForm.style.display = 'none';
          userPanel.style.display = 'block';
        } else {
          changePasswordError.textContent = data.error || 'Échec du changement de mot de passe.';
          changePasswordError.style.display = 'block';
        }
      } catch (error) {
        console.error('Erreur réseau:', error);
        changePasswordError.textContent = 'Erreur réseau. Vérifie la console.';
        changePasswordError.style.display = 'block';
      }
    });

    // Déconnexion
    document.getElementById('logout-btn').addEventListener('click', function() {
      logout();
    });

    function logout() {
      localStorage.removeItem('loggedIn');
      localStorage.removeItem('user');
      userPanel.style.display = 'none';
      loginForm.style.display = 'block';
      window.parent.postMessage({ action: 'logoutSuccess' }, '*');
    }
  </script>
</body>
</html>