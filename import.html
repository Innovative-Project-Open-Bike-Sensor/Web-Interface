<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Import</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="iframe-page">
  <h2>Import Data</h2>
  <div id="not-logged-in" style="display: block; max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
    <p>Please <a href="#" onclick="window.parent.postMessage({action: 'openTab', tab: 'account'}, '*'); return false;" style="color: #555; text-decoration: underline; cursor: pointer;">login</a> to import data.</p>
  </div>

  <div id="import-section" style="display: none;">
    <p>Import your tracks in JSON format.</p>
    <input type="file" id="json-file" accept=".json">
    <button id="import-btn">Import</button>
    <p id="import-status"></p>
  </div>

  <script>
    const notLoggedIn = document.getElementById('not-logged-in');
    const importSection = document.getElementById('import-section');
    const importBtn = document.getElementById('import-btn');
    const jsonFile = document.getElementById('json-file');
    const importStatus = document.getElementById('import-status');

    // Fonction pour vérifier l'état de connexion
    function checkLoginStatus() {
      if (localStorage.getItem('loggedIn') === 'true') {
        notLoggedIn.style.display = 'none';
        importSection.style.display = 'block';
      } else {
        notLoggedIn.style.display = 'block';
        importSection.style.display = 'none';
      }
    }

    // Écoute les messages de l'iframe parent
    window.addEventListener('message', (event) => {
      if (event.data.action === 'loginSuccess') {
        checkLoginStatus(); // Met à jour l'affichage
      } else if (event.data.action === 'logoutSuccess') {
        checkLoginStatus(); // Met à jour l'affichage
      }
    });

    // Vérifie l'état initial
    checkLoginStatus();

    // Bouton d'import
    importBtn.addEventListener('click', async function() {
      const file = jsonFile.files[0];
      if (!file) {
        importStatus.textContent = 'Veuillez sélectionner un fichier.';
        importStatus.style.color = 'red';
        return;
      }

      try {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) {
              throw new Error('Le fichier doit contenir un tableau JSON.');
            }

            for (const point of data) {
              const response = await fetch('https://lilied-subprofessionally-mafalda.ngrok-free.dev/api/measurements', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-API-KEY': 'openbikecle',
                  'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(point)
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Échec de l\'import.');
              }
            }

            importStatus.textContent = 'Import réussi !';
            importStatus.style.color = 'green';
          } catch (err) {
            importStatus.textContent = `Erreur : ${err.message}`;
            importStatus.style.color = 'red';
          }
        };
        reader.readAsText(file);
      } catch (error) {
        importStatus.textContent = 'Erreur réseau. Vérifie la console.';
        importStatus.style.color = 'red';
      }
    });
  </script>
</body>
</html>